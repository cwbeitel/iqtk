machine:
  environment:
    CLOUDSDK_CORE_DISABLE_PROMPTS: 1
    BASE_BUILD_TAG: iqtk-base
    BUILD_TAG: iqtk:0.0.3
    GCR_REGISTRY: gcr.io/jbei-cloud
    QUAY_REGISTRY: quay.io/iqtk
  services:
    - docker

dependencies:
  cache_directories:
    - "/home/ubuntu/.cache/bazel"
    - "~/docker"
    - ~/google-cloud-sdk

  override:
    - docker info
    - if [[ -e ~/docker/build-cache.tar ]]; then docker load --input ~/docker/build-cache.tar; fi
    - inquiry/tools/ci_build/ci_build.sh ls /bazel
    - mkdir -p ~/docker; docker save ${BASE_BUILD_TAG} > ~/docker/build-cache.tar

test:
  override:
    - inquiry/tools/ci_build/ensure_gcloud_installed.sh
    - inquiry/tools/ci_build/ci_build.sh inquiry/tools/ci_build/builds/pip.sh
  post:
    - inquiry/tools/ci_build/builds/build_release_container.sh

deployment:
  prod:
    branch: master
    commands:
      # Quay registry push requires quay creds. specified as environment vars.
      # via. the CircleCI settings UI (Build settings > Environment variables)
      - docker login -u ${DOCKER_USER} -p ${DOCKER_PASS} -e ${DOCKER_EMAIL} quay.io
      - docker tag ${BUILD_TAG} ${QUAY_REGISTRY}/${BUILD_TAG}
      - docker push ${QUAY_REGISTRY}/${BUILD_TAG}

      # To push to GCR, must have defined a GCP service account credentials with
      # permission to push to the specified registry via. SA_KEY and SA_EMAIL
      # variables in the CircleCI env., as above.
      # - inquiry/tools/ci_build/auth_gcloud.sh
      # - docker tag ${BUILD_TAG} ${GCR_REGISTRY}/${BUILD_TAG}
      # - gcloud docker -- push ${GCR_REGISTRY}/${BUILD_TAG}
