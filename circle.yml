machine:
  environment:
    CLOUDSDK_CORE_DISABLE_PROMPTS: 1
    BASE_BUILD_TAG: iqtk-base
    BUILD_TAG: iqtk:0.0.3
    #REGISTRY: gcr.io/jbei-cloud
    REGISTRY: quay.io/iqtk
  services:
    - docker

dependencies:
  cache_directories:
    - "/home/ubuntu/.cache/bazel"
    - "~/docker"
    - ~/google-cloud-sdk

  override:
    - docker info
    - if [[ -e ~/docker/build-cache.tar ]]; then docker load --input ~/docker/build-cache.tar; fi
    - inquiry/tools/ci_build/ci_build.sh ls /bazel
    - mkdir -p ~/docker; docker save ${BASE_BUILD_TAG} > ~/docker/build-cache.tar

test:
  override:
    - inquiry/tools/ci_build/ensure_gcloud_installed.sh
    - inquiry/tools/ci_build/ci_build.sh inquiry/tools/ci_build/builds/pip.sh
  post:
    #- bazel build //inquiry/...
    - inquiry/tools/ci_build/builds/build_release_container.sh

deployment:
  prod:
    branch: master
    commands:
      #- inquiry/tools/ci_build/auth_gcloud.sh
      #- docker tag ${BUILD_TAG} gcr.io/${GCR_REGISTRY_ACCT}/${BUILD_TAG}
      # To push to GCR, must have defined SA_KEY and SA_EMAIL in ci env.
      #- gcloud docker -- push gcr.io/${GCR_REGISTRY_ACCT}/${BUILD_TAG}
      - docker tag ${BUILD_TAG} ${REGISTRY}/${BUILD_TAG}
      - docker login quay.io -u ${DOCKER_USER} -p ${DOCKER_PASS}
      - docker push ${REGISTRY}/${BUILD_TAG}
